---
import { fetchProfileById } from "@/lib/services/profile.service";
import { createSupabaseServerClient } from "@/db/supabase.client";
import { Button } from "./ui/button";

const { user } = Astro.locals;
const isAuthenticated = !!user;

let username: string | undefined;

if (isAuthenticated) {
  const supabase = createSupabaseServerClient({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });
  const profile = await fetchProfileById(supabase, user.id);
  username = profile?.username;
}
---

<header class="bg-background border-b">
  <div class="container mx-auto">
    <nav class="flex h-16 items-center justify-between">
      <a href="/" class="text-xl font-bold">Masz Pan</a>
      <ul class="flex gap-4 items-center">
        <li>
          <a href="/" class="text-sm font-medium text-muted-foreground transition-colors hover:text-primary"
            >Wyszukaj narzędzie</a
          >
        </li>
        {
          isAuthenticated ? (
            <>
              <li>
                <a
                  href="/tools/my"
                  class="text-sm font-medium text-muted-foreground transition-colors hover:text-primary"
                >
                  Moje narzędzia
                </a>
              </li>
              <li>
                <a
                  href="/reservations/my"
                  class="text-sm font-medium text-muted-foreground transition-colors hover:text-primary"
                >
                  Moje rezerwacje
                </a>
              </li>
              <li>
                <a
                  href="/tokens"
                  class="text-sm font-medium text-muted-foreground transition-colors hover:text-primary"
                >
                  Moje żetony
                </a>
              </li>
              <li>
                <a
                  href="/tools/new"
                  class="text-sm font-medium text-muted-foreground transition-colors hover:text-primary"
                >
                  Dodaj narzędzie
                </a>
              </li>
              <li>
                <a
                  href="/profile"
                  class="text-sm font-medium text-muted-foreground transition-colors hover:text-primary"
                >
                  Mój profil
                </a>
              </li>
              <li>
                <Button
                  id="logout-button"
                  type="button"
                  variant="ghost"
                  className="p-0 h-auto font-medium text-muted-foreground"
                >
                  Wyloguj
                </Button>
              </li>
            </>
          ) : (
            <>
              <li>
                <a
                  href="/auth/login"
                  class="text-sm font-medium text-muted-foreground transition-colors hover:text-primary"
                >
                  Zaloguj
                </a>
              </li>
              <li>
                <a
                  href="/auth/register"
                  class="text-sm font-medium text-muted-foreground transition-colors hover:text-primary"
                >
                  Zarejestruj
                </a>
              </li>
            </>
          )
        }
      </ul>
    </nav>
    {
      username && (
        <div class="flex justify-end pb-2 text-sm text-muted-foreground">
          <span>
            Zalogowany jako: <strong class="font-semibold text-foreground">{username}</strong>
          </span>
        </div>
      )
    }
  </div>
</header>

<script>
  const logoutButton = document.getElementById("logout-button");
  if (logoutButton) {
    logoutButton.addEventListener("click", async () => {
      const response = await fetch("/api/auth/logout", {
        method: "POST",
      });

      if (response.ok) {
        window.location.href = "/";
      } else {
        console.error("Logout failed");
        alert("Wystąpił błąd podczas wylogowywania.");
      }
    });
  }
</script>
