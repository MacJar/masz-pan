---
import { fetchProfileById, getRatingSummary } from "@/lib/services/profile.service";
import { createSupabaseServerClient } from "@/db/supabase.client";
import { Button } from "./ui/button";

const { user } = Astro.locals;
const isAuthenticated = !!user;

let username: string | undefined;
let ratingText: string | undefined;

if (isAuthenticated) {
  const supabase = createSupabaseServerClient({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });
  const profile = await fetchProfileById(supabase, user.id);
  username = profile?.username;

  const ratingSummary = await getRatingSummary(supabase, user.id);
  if (ratingSummary) {
    if (ratingSummary.avg_stars !== null && ratingSummary.ratings_count > 0) {
      ratingText = `⭐ ${ratingSummary.avg_stars.toFixed(1)} (${ratingSummary.ratings_count} ocen)`;
    } else {
      ratingText = "brak ocen";
    }
  }
}
---

<header class="relative">
  <div class="container mx-auto flex items-center min-h-[140px] relative">
    <a href="/" class="absolute left-4 top-1/2 -translate-y-1/2 flex items-center" aria-label="Masz Pan">
      <img src="/masz-pan-logo.png" alt="Masz Pan" class="h-30 w-auto" loading="lazy" decoding="async" />
      <span class="sr-only">Masz Pan</span>
    </a>
    <nav class="flex-1 flex h-35 items-center justify-end">
      <ul class="flex gap-8 items-center">
        <li>
          <a href="/" class="nav-link text-lg font-medium text-muted-foreground">Wyszukaj narzędzie</a>
        </li>
        {
          isAuthenticated ? (
            <>
              <li>
                <a href="/tools/my" class="nav-link text-lg font-medium text-muted-foreground">
                  Moje narzędzia
                </a>
              </li>
              <li>
                <a href="/reservations/my" class="nav-link text-lg font-medium text-muted-foreground">
                  Moje rezerwacje
                </a>
              </li>
              <li>
                <a href="/tokens" class="nav-link text-lg font-medium text-muted-foreground">
                  Moje żetony
                </a>
              </li>
              <li>
                <a href="/tools/new" class="nav-link text-lg font-medium text-muted-foreground">
                  Dodaj narzędzie
                </a>
              </li>
              <li>
                <a href="/profile" class="nav-link text-lg font-medium text-muted-foreground">
                  Mój profil
                </a>
              </li>
              <li>
                <Button
                  id="logout-button"
                  type="button"
                  variant="ghost"
                  className="nav-link p-0 h-auto text-lg font-medium text-muted-foreground"
                >
                  Wyloguj
                </Button>
              </li>
            </>
          ) : (
            <>
              <li>
                <a href="/auth/login" class="nav-link text-lg font-medium text-muted-foreground">
                  Zaloguj
                </a>
              </li>
              <li>
                <a href="/auth/register" class="nav-link text-lg font-medium text-muted-foreground">
                  Zarejestruj
                </a>
              </li>
            </>
          )
        }
      </ul>
    </nav>
    {
      username && (
        <div class="absolute bottom-0 right-4 flex justify-end pb-4 text-sm text-muted-foreground">
          <span>
            Zalogowany jako: <strong class="font-semibold text-foreground">{username}</strong>
            {ratingText && <span class="ml-2">| {ratingText}</span>}
          </span>
        </div>
      )
    }
  </div>
</header>

<script
  is:inline
  set:html={`
    const logoutButton = document.getElementById("logout-button");
    if (logoutButton) {
      logoutButton.addEventListener("click", async () => {
        const response = await fetch("/api/auth/logout", {
          method: "POST",
        });

        if (response.ok) {
          window.location.href = "/";
        } else {
          console.error("Logout failed");
          alert("Wystąpił błąd podczas wylogowywania.");
        }
      });
    }
  `}
/>
