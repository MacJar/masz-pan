---
import Layout from "@/layouts/Layout.astro";
import ToolDetailsView from "@/components/tools/ToolDetailsView";
import type { ToolWithImagesDTO } from "@/types";
import { z } from "zod";

export const prerender = false;

const { id } = Astro.params;
const { user } = Astro.locals;
const currentUserId = user?.id ?? null;

const idSchema = z.string().uuid();
const validation = idSchema.safeParse(id);

if (!validation.success) {
  return Astro.redirect("/404");
}

let tool: ToolWithImagesDTO;
try {
  const response = await fetch(`${Astro.url.origin}/api/tools/${id}`);

  if (!response.ok) {
    if (response.status === 404) {
      return Astro.redirect("/404");
    }
    throw new Error(`API responded with status: ${response.status}`);
  }
  tool = await response.json();
} catch {
  // TODO: Add a proper error page
  return new Response("Internal Server Error", { status: 500 });
}
---

<Layout title={tool.name}>
  <main class="container mx-auto px-4 py-8">
    <ToolDetailsView initialToolData={tool} currentUserId={currentUserId} client:load />
  </main>
</Layout>
